name: Rust Build

on:
  push:
    tags:
      - 'refs/head/master'
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Install cargo-skyline
      run: cargo install --git https://github.com/jam1garner/cargo-skyline
    - name: Install rust-std-skyline-squashed
      run: cd .. && git clone https://github.com/jam1garner/rust-std-skyline-squashed && cd -
    - name: Attempt to build
      run: PATH=$PATH:/usr/share/rust/.rustup/toolchains/nightly-2020-04-10-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/bin cargo skyline build --release
#     - name: GitHub Create Tag Release
#       id: create_release
#       uses: Roang-zero1/github-create-release-action@v2.1.0
#       env:
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#       with:
#         # Any version matching this regular expression will be marked as pre-release. Disabled by default.
#         prerelease_regex: .* # optional, default is 
#         # Create the releases as draft (true|false [default: false]). Existing will not be updated from released to draft.
#         create_draft: false # optional, default is false
#         # Controls whether an existing release should be updated with data from the latest push (true|false [default: false]).
#         update_existing: true # optional, default is false
#         # Allows to pass an already created tag, forces update_existing to true.
#         created_tag: master # optional, default is 
#         # Allows to pass a title for the release.
#         release_title: master # optional, default is 
    - name: Check release
      id: check_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: bruceadams/get-release@v1.2.0
    - name: Create a Release
      if: ${{ failure() }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: actions/create-release@v1
      with:
        # The name of the tag. This should come from the webhook payload, `github.GITHUB_REF` when a user pushes a new tag
        tag_name: master
        # The name of the release. For example, `Release v1.0.1`
        release_name: master
        # Text describing the contents of the tag.
        body: Build of skyline-rs-template from master. # optional
        # `true` to create a draft (unpublished) release, `false` to create a published one. Default: `false`
        draft: false # optional
        # `true` to identify the release as a prerelease. `false` to identify the release as a full release. Default: `false`
        prerelease: true # optional
    - name: Get Release
      id: get_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: bruceadams/get-release@v1.2.0
    - name: Upload Release Asset
      id: upload-release-asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.get_release.outputs.upload_url }}
        asset_path: ./target/aarch64-skyline-switch/release/libskyline_rs_template.nro
        asset_name: libskyline_rs_template.nro
        asset_content_type: application/octet-stream

# uncomment the build step below to build on every change to master.

#     - name: Upload Release
#       uses: majkrzak/create-release@latest
#       with:
#         token: ${{ secrets.GITHUB_TOKEN }}
#         name: master
#         code: master
#         body: Build of skyline-rs-template from master.
#         prerelease: true
#         recreate: true
#         assets: ./target/aarch64-skyline-switch/release/libskyline_rs_template.nro:libskyline_rs_template.nro:application/octet-stream
  

